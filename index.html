<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>靈感問路站 | 擲筊・三元牌・指引</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&display=swap');
        
        body {
            font-family: 'Noto Serif TC', serif;
            transition: background-color 0.8s ease;
            overflow-x: hidden;
        }

        /* --- Animations --- */
        @keyframes toss {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-50px) rotate(180deg); }
            50% { transform: translateY(0) rotate(360deg); }
            75% { transform: translateY(-20px) rotate(540deg); }
            100% { transform: translateY(0) rotate(720deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes cardReveal {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes float-card {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        @keyframes float-particle {
            0% { transform: translateY(0px) translateX(0px); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-100px) translateX(20px); opacity: 0; }
        }

        .animate-toss { animation: toss 0.8s ease-in-out; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .animate-card-reveal { animation: cardReveal 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .animate-float { animation: float-card 6s ease-in-out infinite; }
        
        .moon-block {
            width: 80px;
            height: 40px;
            border-radius: 2px 2px 40px 40px;
            transition: all 0.5s ease;
            position: relative;
        }
        
        .block-round {
            background-color: #a05248;
            box-shadow: inset 0 -4px 8px rgba(0,0,0,0.1);
            transform: rotateX(0deg); 
        }

        .block-flat {
            background-color: #dcd0c0;
            border: 2px solid #a05248;
            transform: rotateX(180deg); 
        }

        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            filter: blur(1px);
        }

        .font-latin {
            font-family: 'Cinzel', serif;
        }
        
        .selection-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            background-color: #a05248;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
            z-index: 20;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 主題切換的平滑過渡 */
        .theme-transition {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 拖曳游標樣式 */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Cards: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M8 2v20"/><path d="M20 12h-8"/><path d="M4 12h-2"/></svg>,
            Compass: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
        };

        // --- 1. 擲筊元件 ---
        const MoonBlocks = () => {
            const [status, setStatus] = useState("ready"); 
            const [blocks, setBlocks] = useState([0, 0]); 
            const [resultText, setResultText] = useState("");
            const [resultDesc, setResultDesc] = useState("");

            const toss = () => {
                if (status === "tossing") return;
                setStatus("tossing");
                setResultText("");
                setResultDesc("");

                setTimeout(() => {
                    const b1 = Math.random() > 0.5 ? 1 : 0;
                    const b2 = Math.random() > 0.5 ? 1 : 0;
                    setBlocks([b1, b2]);
                    
                    const sum = b1 + b2;
                    let text = "";
                    let desc = "";

                    if (sum === 1) {
                        text = "聖筊";
                        desc = "所願可成，心誠則靈。";
                    } else if (sum === 2) {
                        text = "笑筊";
                        desc = "機緣未定，或再三思。";
                    } else {
                        text = "陰筊";
                        desc = "時機未到，靜候佳音。";
                    }

                    setResultText(text);
                    setResultDesc(desc);
                    setStatus("result");
                }, 800);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[500px] animate-fade-in">
                    <div className="mb-12 text-center">
                        <p className="text-[#888] text-sm tracking-widest mb-2 font-light">HEART SINCERITY</p>
                        <p className="text-[#555] tracking-widest">默念姓名與所求之事</p>
                    </div>

                    <div className="flex gap-10 mb-12 h-24 items-center">
                        <div className={`moon-block ${status === 'tossing' ? 'animate-toss' : ''} ${blocks[0] === 1 ? 'block-flat' : 'block-round'}`}></div>
                        <div className={`moon-block ${status === 'tossing' ? 'animate-toss' : ''} ${blocks[1] === 1 ? 'block-flat' : 'block-round'}`}></div>
                    </div>

                    {status === "result" && (
                        <div className="text-center animate-fade-in mb-8">
                            <h2 className="text-3xl font-light text-[#a05248] mb-2 tracking-[0.2em]">{resultText}</h2>
                            <div className="w-8 h-[1px] bg-[#dcd0c0] mx-auto my-3"></div>
                            <p className="text-[#777] text-sm tracking-wider">{resultDesc}</p>
                        </div>
                    )}

                    <button 
                        onClick={toss}
                        disabled={status === 'tossing'}
                        className="bg-[#6b6b6b] hover:bg-[#555] text-[#f4f4f0] text-sm tracking-widest py-3 px-10 transition-colors duration-500 disabled:opacity-50 disabled:cursor-not-allowed outline-none rounded-sm shadow-md"
                    >
                        {status === 'tossing' ? '...' : '擲 筊'}
                    </button>
                </div>
            );
        };

        // --- 2. 三元牌元件 ---
        const TriadCards = () => {
            const [stage, setStage] = useState('main-select'); // main-select, main-reveal, sub-select, final-reveal, final-overview
            const [mainOrder, setMainOrder] = useState([]); 
            const [subOrder, setSubOrder] = useState([]);
            const [particles, setParticles] = useState([]);
            const scrollRef = useRef(null);

            // Data Definitions
            const mainCardsData = [
                { id: 'origin', title: 'Origo Animae', deTitle: 'Ursprung der Seele', img: 'https://img.yra.tw/x/Origo%20Animae-2.png' },
                { id: 'bond', title: 'Transmutatio Vinculi', deTitle: 'Wandel der Verbindung', img: 'https://img.yra.tw/x/Transmutatio%20Vinculi-2.png' },
                { id: 'future', title: 'Realis Futura', deTitle: 'Verwirklichung der Zukunft', img: 'https://img.yra.tw/x/Reakis%20Futura-2.png' }
            ];

            const subCardsData = [
                { id: 'arbor', title: 'Arbor', img: 'https://img.yra.tw/x/Arbor-1.png' },
                { id: 'astra', title: 'ASTRA', img: 'https://img.yra.tw/x/ASTRA-2.png' },
                { id: 'semen', title: 'Semen', img: 'https://img.yra.tw/x/Semen02.png' }
            ];

            // Interpretation Dictionary (Updated to be neutral/descriptive)
            const interpretations = {
                main: {
                    "origin-bond-future": {
                        title: "Radix Circulus", zhTitle: "根源環圈",
                        poem: "根莖深埋影中，喚醒交織的脈流，\n焰光碎星河，預言的環圈永轉。\n起源之息，化作未來的漩渦。",
                        note: "根源轉變至實現相當流暢，若對未來感到不確定——請借過去力量前行。"
                    },
                    "origin-future-bond": {
                        title: "Semen Stellarum", zhTitle: "星辰種子",
                        poem: "起源的種焰，躍入星辰的裂隙，\n轉變遲來，卻織成無形的橋梁。\n未來先至，牽引根源的低語。",
                        note: "起源直達未來，轉變雖緩——請用未來視野連結現在。"
                    },
                    "bond-origin-future": {
                        title: "Vinculum Radicis", zhTitle: "根源連結",
                        poem: "連結的波瀾，溯回隱藏的根源，\n實現如影隨形，點亮遺忘的火種。\n轉變為首，循環中尋得永恆。",
                        note: "轉變引導著根源，實現隱於其中——請從連結中尋找永續平衡。"
                    },
                    "bond-future-origin": {
                        title: "Fluctus Originis", zhTitle: "起源波瀾",
                        poem: "互織的線索，引領焰河奔向盡頭，\n起源回響，成為未來的幽光。\n轉變開啟，根莖在星中重生。",
                        note: "轉變推動實現，起源產生回響——請用未來光輝重塑根基。"
                    },
                    "future-origin-bond": {
                        title: "Astra Radix", zhTitle: "根源星辰",
                        poem: "預言的星芒，先落起源的土壤，\n連結緩緩綻放，如霧中隱現的藤。\n未來引路，根源與轉變交融。",
                        note: "未來喚醒起源，連結正緩緩發生——讓預言融合內外。"
                    },
                    "future-bond-origin": {
                        title: "Vortex Seminis", zhTitle: "種子漩渦",
                        poem: "實現的漩渦，吞噬連結的餘輝，\n起源悄然甦醒，在影中編織新環。\n未來倒轉，根莖成為永夜的燈。",
                        note: "未來轉化連結，起源正在甦醒——用漩渦力量照亮黑暗。"
                    }
                },
                sub: {
                    "semen-arbor-astra": {
                        title: "Umbra Arboris", zhTitle: "樹影幽暗",
                        poem: "種子的幽暗，蔓生樹影的糾纏，\n星辰遙遠，卻在根中隱藏呼喚。\n起源不滿，指引向光的無形枝。",
                        note: "起源蔓延至未來，請從根源尋找光亮，療癒內在的糾纏。"
                    },
                    "semen-astra-arbor": {
                        title: "Fragmentum Stellarum", zhTitle: "星辰碎粒",
                        poem: "起源的碎粒，散落星河的邊緣，\n樹木遲緩生長，承載預言的重量。\n種焰黯淡，指引在夜中尋枝。",
                        note: "起源散落於未來，需用樹木支撐——耐心承載未知。"
                    },
                    "arbor-semen-astra": {
                        title: "Curvus Seminis", zhTitle: "種子彎曲",
                        poem: "樹枝的彎曲，壓抑種子的脈動，\n星光滲入，喚醒遺失的軌跡。\n現在不滿，指引起源通往天穹。",
                        note: "現在壓抑了起源，讓星光滲入——從根源通向廣闊。"
                    },
                    "arbor-astra-semen": {
                        title: "Velum Astrae", zhTitle: "星辰面紗",
                        poem: "樹影遮蔽星途，預言如風掠過，\n種子回歸土中，孕育新的輪迴。\n現在黯然，指引未來回溯根源。",
                        note: "現在遮蔽了未來，回歸種子——用輪迴重塑平衡。"
                    },
                    "astra-semen-arbor": {
                        title: "Cadens Seminis", zhTitle: "種子墜落",
                        poem: "星辰的墜落，攪動種子的沉睡，\n樹枝伸展，捕捉遺落的輝芒。\n未來不滿，指引起源化作綠焰。",
                        note: "未來攪動了起源，樹枝捕捉——轉化墜落為新生力量。"
                    },
                    "astra-arbor-semen": {
                        title: "Wurzelstern", zhTitle: "根源之星",
                        poem: "預言之星，纏繞樹木的枝蔓，\n種子深藏，等待循環的召喚。\n未來朦朧，指引現在回歸塵土。",
                        note: "未來纏繞著現在，回歸種子——在等待中尋找召喚。"
                    }
                }
            };

            // Enhanced Drag-to-Scroll Hook
            const useDraggableScroll = (ref) => {
                const isDown = useRef(false);
                const startX = useRef(0);
                const scrollLeft = useRef(0);
                const isDragging = useRef(false); 
                const [draggingState, setDraggingState] = useState(false);

                const onMouseDown = (e) => {
                    isDown.current = true;
                    isDragging.current = false;
                    startX.current = e.pageX - ref.current.offsetLeft;
                    scrollLeft.current = ref.current.scrollLeft;
                };

                const onMouseLeave = () => {
                    isDown.current = false;
                    isDragging.current = false;
                    setDraggingState(false);
                };

                const onMouseUp = () => {
                    isDown.current = false;
                    setTimeout(() => {
                        isDragging.current = false;
                        setDraggingState(false);
                    }, 0);
                };

                const onMouseMove = (e) => {
                    if (!isDown.current) return;
                    e.preventDefault();
                    const x = e.pageX - ref.current.offsetLeft;
                    const walk = (x - startX.current) * 2;
                    
                    if (Math.abs(x - startX.current) > 5) {
                        isDragging.current = true;
                        setDraggingState(true);
                        ref.current.scrollLeft = scrollLeft.current - walk;
                    }
                };

                return { 
                    events: { onMouseDown, onMouseLeave, onMouseUp, onMouseMove }, 
                    isDragging, 
                    draggingState 
                };
            };

            useEffect(() => {
                const newParticles = [];
                for(let i=0; i<40; i++){
                    newParticles.push({
                        id: i, top: Math.random() * 100 + '%', left: Math.random() * 100 + '%',
                        size: Math.random() * 2 + 'px', duration: Math.random() * 5 + 5 + 's', delay: Math.random() * 5 + 's'
                    });
                }
                setParticles(newParticles);
            }, []);

            const handleMainClick = (id) => {
                if (stage !== 'main-select') return;
                if (mainOrder.includes(id)) setMainOrder(mainOrder.filter(item => item !== id));
                else if (mainOrder.length < 3) setMainOrder([...mainOrder, id]);
            };

            const handleSubClick = (id) => {
                if (stage !== 'sub-select') return;
                if (subOrder.includes(id)) setSubOrder(subOrder.filter(item => item !== id));
                else if (subOrder.length < 3) setSubOrder([...subOrder, id]);
            };

            const getSelectionIndex = (id, list) => {
                const index = list.indexOf(id);
                return index !== -1 ? index + 1 : null;
            };

            const getCard = (id, list) => list.find(c => c.id === id);

            // Helper to get result data
            const getResultData = (type) => {
                if (type === 'main' && mainOrder.length === 3) {
                    const key = mainOrder.join('-');
                    return interpretations.main[key];
                }
                if (type === 'sub' && subOrder.length === 3) {
                    const key = subOrder.join('-');
                    return interpretations.sub[key];
                }
                return null;
            };

            const dragEvents = useDraggableScroll(scrollRef);

            // Card Item Component
            const CardItem = ({ card, orderList, onClick, isSelectable, isDraggingRef }) => {
                const selectIdx = getSelectionIndex(card.id, orderList);
                const floatDelay = `${card.id.charCodeAt(0) % 5}s`;

                const handleClick = (e) => {
                    if (isSelectable && !isDraggingRef.current) {
                        onClick(card.id);
                    }
                };

                return (
                    <div className="snap-center shrink-0 w-[75vw] sm:w-[320px] md:w-[280px] flex flex-col items-center justify-center p-4">
                        <div 
                            onClick={handleClick}
                            className={`relative w-full aspect-[2/3] rounded-xl overflow-hidden shadow-2xl transition-all duration-500 ease-out group ${isSelectable ? 'animate-float cursor-pointer' : ''} ${selectIdx ? 'ring-2 ring-[#a05248] scale-95 opacity-60' : 'hover:scale-105 hover:z-10'}`}
                            style={{ animationDelay: floatDelay }}
                        >
                            <img src={card.img} alt="card" className="w-full h-full object-cover pointer-events-none select-none" />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-60 transition-opacity group-hover:opacity-40"></div>
                            
                            {/* Hover Overlay */}
                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                                <div className="bg-black/20 p-2 rounded-full backdrop-blur-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.7)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                                </div>
                            </div>

                            {selectIdx && <div className="selection-badge">{selectIdx}</div>}
                        </div>
                    </div>
                );
            };

            return (
                <div className="relative flex flex-col items-center min-h-[600px] w-full animate-fade-in overflow-hidden">
                    <div className="absolute inset-0 bg-transparent z-0">
                         {particles.map(p => (
                            <div key={p.id} className="particle opacity-20" style={{
                                top: p.top, left: p.left, width: p.size, height: p.size,
                                animation: `float-particle ${p.duration} ease-in-out infinite`,
                                animationDelay: p.delay
                            }}></div>
                        ))}
                    </div>

                    <div className="relative z-10 w-full flex flex-col h-full py-8">
                        <div className="text-center mb-4 px-4">
                            <p className="text-[#888] text-[10px] md:text-xs font-latin tracking-[0.3em] mb-2 uppercase opacity-70">
                                {stage.includes('main') ? 'Phase I : Origin' : (stage.includes('sub') ? 'Phase II : Subconscious' : 'Phase III : Integration')}
                            </p>
                            <h2 className="text-lg md:text-xl font-light text-[#e0e0e0] tracking-widest min-h-[3rem] drop-shadow-lg transition-all duration-500">
                                {stage === 'main-select' && "主牌組：依照你現在生活中的感受，選擇最優先的順序"}
                                {stage === 'main-reveal' && "三元顯現：連結、起源與未來"}
                                {stage === 'sub-select' && "子牌組：依照你現在生活中的感受，選擇最不優先的順序"}
                                {stage === 'final-reveal' && "命運之流：潛意識的低語"}
                                {stage === 'final-overview' && "全覽對照：顯意識與潛意識的交織"}
                            </h2>
                        </div>

                        {(stage === 'main-select' || stage === 'sub-select') && (
                            <div className="flex-1 flex flex-col items-center justify-center w-full">
                                <div 
                                    ref={scrollRef}
                                    {...dragEvents.events}
                                    className={`w-full flex overflow-x-auto snap-x snap-mandatory gap-4 px-[12.5vw] sm:px-[calc(50%-160px)] md:px-[calc(50%-140px)] py-10 no-scrollbar items-center select-none ${dragEvents.draggingState ? 'cursor-grabbing' : 'cursor-grab'}`}
                                >
                                    {(stage === 'main-select' ? mainCardsData : subCardsData).map((card) => (
                                        <CardItem 
                                            key={card.id} 
                                            card={card} 
                                            orderList={stage === 'main-select' ? mainOrder : subOrder} 
                                            onClick={stage === 'main-select' ? handleMainClick : handleSubClick} 
                                            isSelectable={true} 
                                            isDraggingRef={dragEvents.isDragging}
                                        />
                                    ))}
                                    <div className="w-[1px] shrink-0"></div> 
                                </div>
                                <div className="mt-2 text-[#666] text-xs tracking-widest animate-pulse">← DRAG TO BROWSE →</div>
                                <div className="mt-8 h-12">
                                    {(stage === 'main-select' ? mainOrder : subOrder).length === 3 && (
                                        <button onClick={stage === 'main-select' ? () => setStage('main-reveal') : () => setStage('final-reveal')} className="px-10 py-3 bg-[#a05248] text-white rounded-full text-sm tracking-[0.2em] shadow-[0_0_20px_rgba(160,82,72,0.4)] hover:bg-[#b06258] transition-all transform hover:scale-105 animate-fade-in">
                                            {stage === 'main-select' ? '確認顯現' : '揭示全貌'}
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Phase Reveal (Main or Sub) */}
                        {(stage === 'main-reveal' || stage === 'final-reveal') && (
                            <div className="flex-1 flex flex-col items-center w-full px-4 animate-fade-in">
                                {getResultData(stage === 'main-reveal' ? 'main' : 'sub') && (
                                    <div className="max-w-2xl w-full text-center mb-8 bg-black/20 backdrop-blur-sm p-6 rounded-lg border border-white/5 shadow-xl animate-card-reveal">
                                        <div className="mb-4">
                                            <h3 className="text-2xl md:text-3xl font-latin font-bold text-[#d4a373] mb-1 tracking-widest">{getResultData(stage === 'main-reveal' ? 'main' : 'sub').title}</h3>
                                            <p className="text-sm text-[#aaa] tracking-[0.3em] uppercase">{getResultData(stage === 'main-reveal' ? 'main' : 'sub').zhTitle}</p>
                                        </div>
                                        <div className="w-16 h-[1px] bg-white/20 mx-auto my-6"></div>
                                        <p className="text-[#e0e0e0] text-base md:text-lg font-serif leading-loose whitespace-pre-line mb-6 italic opacity-90">
                                            {getResultData(stage === 'main-reveal' ? 'main' : 'sub').poem}
                                        </p>
                                        <div className="bg-[#a05248]/10 p-4 rounded border border-[#a05248]/20 inline-block">
                                            <p className="text-xs text-[#d4a373] tracking-widest">
                                                <span className="font-bold mr-2">✦</span>
                                                {getResultData(stage === 'main-reveal' ? 'main' : 'sub').note}
                                            </p>
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-3 gap-3 md:gap-8 w-full max-w-4xl mt-2">
                                    {(stage === 'main-reveal' ? mainOrder : subOrder).map((id, index) => {
                                        const list = stage === 'main-reveal' ? mainCardsData : subCardsData;
                                        const card = getCard(id, list);
                                        return (
                                            <div key={id} className="flex flex-col items-center animate-card-reveal" style={{ animationDelay: `${index * 0.2 + 0.3}s` }}>
                                                <div className="relative mb-4 w-full aspect-[2/3] shadow-[0_0_30px_rgba(0,0,0,0.5)] rounded-lg overflow-hidden border border-white/10 group">
                                                    <img src={card.img} alt={card.title} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" />
                                                    <div className="selection-badge text-sm !w-8 !h-8">{index + 1}</div>
                                                </div>
                                                <div className="text-center opacity-0 animate-fade-in" style={{ animationDelay: `${index * 0.2 + 0.8}s`, animationFillMode: 'forwards' }}>
                                                    <h3 className="font-latin text-[10px] md:text-xs font-bold text-[#666] mb-1">{card.title}</h3>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="mt-12">
                                    {stage === 'main-reveal' ? (
                                        <button onClick={() => setStage('sub-select')} className="px-8 py-2 border border-[#d4a373] text-[#d4a373] rounded-sm text-xs tracking-[0.2em] hover:bg-[#d4a373] hover:text-black transition-colors uppercase">
                                            前往子牌組
                                        </button>
                                    ) : (
                                        <button onClick={() => setStage('final-overview')} className="px-8 py-2 bg-[#d4a373] text-black rounded-sm text-xs tracking-[0.2em] hover:bg-[#e4b383] transition-colors uppercase shadow-lg">
                                            全覽對照
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Final Overview Mode */}
                        {stage === 'final-overview' && (
                            <div className="flex-1 flex flex-col items-center w-full px-4 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
                                    
                                    {/* Left: Main Cards Result */}
                                    <div className="bg-white/5 backdrop-blur-md rounded-lg p-6 border border-white/10">
                                        <h3 className="text-[#a05248] tracking-widest text-center mb-4 text-sm font-bold border-b border-white/10 pb-2">主牌組：優先順序</h3>
                                        {getResultData('main') && (
                                            <div className="text-center">
                                                <h4 className="font-latin text-lg text-[#d4a373] mb-1">{getResultData('main').title}</h4>
                                                <p className="text-xs text-[#888] mb-4">{getResultData('main').zhTitle}</p>
                                                <p className="text-[#ccc] text-sm font-serif leading-relaxed mb-4 italic">
                                                    {getResultData('main').poem}
                                                </p>
                                                <p className="text-xs text-[#d4a373] tracking-wide bg-black/20 p-3 rounded">
                                                    {getResultData('main').note}
                                                </p>
                                            </div>
                                        )}
                                        {/* Mini Cards Row */}
                                        <div className="flex justify-center gap-2 mt-6 opacity-80">
                                            {mainOrder.map((id, idx) => (
                                                <div key={id} className="w-10 h-16 rounded overflow-hidden border border-white/20 relative">
                                                    <img src={getCard(id, mainCardsData).img} className="w-full h-full object-cover" />
                                                    <div className="absolute top-0 right-0 bg-[#a05248] text-white text-[8px] w-3 h-3 flex items-center justify-center">{idx+1}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Right: Sub Cards Result */}
                                    <div className="bg-white/5 backdrop-blur-md rounded-lg p-6 border border-white/10">
                                        <h3 className="text-[#a05248] tracking-widest text-center mb-4 text-sm font-bold border-b border-white/10 pb-2">子牌組：非優先順序</h3>
                                        {getResultData('sub') && (
                                            <div className="text-center">
                                                <h4 className="font-latin text-lg text-[#d4a373] mb-1">{getResultData('sub').title}</h4>
                                                <p className="text-xs text-[#888] mb-4">{getResultData('sub').zhTitle}</p>
                                                <p className="text-[#ccc] text-sm font-serif leading-relaxed mb-4 italic">
                                                    {getResultData('sub').poem}
                                                </p>
                                                <p className="text-xs text-[#d4a373] tracking-wide bg-black/20 p-3 rounded">
                                                    {getResultData('sub').note}
                                                </p>
                                            </div>
                                        )}
                                         {/* Mini Cards Row */}
                                         <div className="flex justify-center gap-2 mt-6 opacity-80">
                                            {subOrder.map((id, idx) => (
                                                <div key={id} className="w-10 h-16 rounded overflow-hidden border border-white/20 relative">
                                                    <img src={getCard(id, subCardsData).img} className="w-full h-full object-cover" />
                                                    <div className="absolute top-0 right-0 bg-[#555] text-white text-[8px] w-3 h-3 flex items-center justify-center">{idx+1}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                </div>

                                <div className="mt-12">
                                    <button onClick={() => { setStage('main-select'); setMainOrder([]); setSubOrder([]); }} className="px-8 py-2 text-[#666] rounded-full text-xs tracking-widest hover:text-[#bbb] transition-colors">
                                        重置儀式
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 3. 宇宙指引元件 ---
        const RandomGuide = () => {
            const [status, setStatus] = useState("ready");
            const [currentGuide, setCurrentGuide] = useState({ main: "", sub: "" });
            const [particles, setParticles] = useState([]);
            
            const guides = [
                { main: "「行到水窮處，坐看雲起時」", sub: "— 王維。適合靜觀其變，答案就在轉彎處。" },
                { main: "「萬物皆有裂痕，那是光照進來的地方」", sub: "— 萊昂納德·科恩。擁抱不完美，那是突破點。" },
                { main: "「月が綺麗ですね」", sub: "（月色真美）— 夏目漱石。珍惜眼前的含蓄與美好，不必急著說破。" },
                { main: "「Stay hungry, stay foolish.」", sub: "（求知若渴，虛懷若谷）— 保持初衷，大膽去闖。" },
                { main: "「回首向來蕭瑟處，也無風雨也無晴」", sub: "— 蘇軾。看淡得失，平靜是最大的力量。" },
                { main: "「The woods are lovely, dark and deep.」", sub: "（森林可愛、幽暗而深邃）— 前方迷人但充滿挑戰，記得你的承諾。" },
                { main: "「既然選擇了遠方，便只顧風雨兼程」", sub: "— 汪國真。目標已定，就不要再回頭猶豫。" },
                { main: "「凡是過往，皆為序章」", sub: "— 莎士比亞。放下過去的包袱，新的篇章正在開始。" },
                { main: "「知其不可而為之」", sub: "— 典出《論語》。有時明知艱難仍要去試，便是你的道。" },
                { main: "「潘朵拉的盒子已打開，但希望仍留其中」", sub: "— 希臘神話。混難中必存生機。" },
                { main: "「衝了，不要猶豫」", sub: "當下的直覺就是最準確的導航。" },
                { main: "「現在不是時候」", sub: "退後一步，讓子彈飛一會兒。" },
                { main: "「問問身邊長輩或智者的意見」", sub: "經驗的火炬能幫你照亮盲點。" },
                { main: "「先去睡一覺，醒來再決定」", sub: "潛意識會在夢中為你整理混亂。" },
                { main: "「放棄也是一種勇氣的表現」", sub: "止損是為了把能量留給更好的事。" }
            ];

            useEffect(() => {
                const newParticles = [];
                for(let i=0; i<30; i++){
                    newParticles.push({
                        id: i, top: Math.random() * 100 + '%', left: Math.random() * 100 + '%',
                        size: Math.random() * 3 + 1 + 'px', duration: Math.random() * 3 + 2 + 's', delay: Math.random() * 2 + 's'
                    });
                }
                setParticles(newParticles);
            }, []);

            const getGuide = () => {
                setStatus("thinking");
                let count = 0;
                const interval = setInterval(() => {
                    const random = guides[Math.floor(Math.random() * guides.length)];
                    setCurrentGuide(random);
                    count++;
                    if(count > 15) { 
                        clearInterval(interval);
                        setStatus("result");
                    }
                }, 80);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[500px] relative animate-fade-in">
                    {particles.map(p => (
                        <div key={p.id} className="particle" style={{
                            top: p.top, left: p.left, width: p.size, height: p.size,
                            animation: `float-particle ${p.duration} ease-in-out infinite`,
                            animationDelay: p.delay
                        }}></div>
                    ))}

                    <div className="mb-8 text-center relative z-10">
                        <p className="text-indigo-200 text-sm tracking-widest opacity-80 font-latin">COSMIC GUIDANCE</p>
                        <p className="text-white text-lg tracking-wider font-light mt-1">宇宙指引</p>
                    </div>

                    <div className="relative mb-12 group z-10">
                        <div className="w-64 h-64 md:w-72 md:h-72 rounded-full flex items-center justify-center relative backdrop-blur-md border border-indigo-400/30 shadow-[0_0_50px_rgba(76,29,149,0.5)]">
                             <div className="absolute inset-0 rounded-full bg-gradient-to-tr from-indigo-900/60 to-purple-500/20"></div>
                             
                             <div className="text-center px-8 relative z-20">
                                {status === 'ready' && (
                                    <span className="text-indigo-200 text-7xl opacity-20 font-thin animate-pulse">?</span>
                                )}
                                {status !== 'ready' && (
                                    <div className={`transition-all duration-500 ${status === 'thinking' ? 'opacity-40' : 'animate-fade-in'}`}>
                                        <p className="text-lg md:text-xl font-medium text-white leading-relaxed mb-3 drop-shadow-[0_0_10px_rgba(255,255,255,0.4)]">
                                            {currentGuide.main}
                                        </p>
                                        {status === 'result' && (
                                            <p className="text-xs md:text-sm text-indigo-200 opacity-80 leading-relaxed font-light">
                                                {currentGuide.sub}
                                            </p>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="absolute -inset-4 border border-indigo-300/10 rounded-full animate-[spin_12s_linear_infinite]"></div>
                        <div className="absolute -inset-8 border border-purple-300/5 rounded-full animate-[spin_18s_linear_infinite_reverse]"></div>
                    </div>

                    <button 
                        onClick={getGuide}
                        disabled={status === 'thinking'}
                        className="relative z-10 bg-indigo-500/20 hover:bg-indigo-500/40 border border-indigo-400/50 text-indigo-100 py-3 px-12 rounded-full backdrop-blur-md transition-all duration-300 hover:shadow-[0_0_20px_rgba(99,102,241,0.4)] disabled:opacity-30 tracking-[0.3em] text-sm"
                    >
                        {status === 'thinking' ? '感應中...' : '接收指引'}
                    </button>
                </div>
            );
        };

        // --- 主程式 App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState("blocks"); 

            // 主題定義
            const themes = {
                blocks: {
                    bg: "bg-[#f4f4f0]",
                    header: "bg-[#f4f4f0] text-[#555] border-b border-[#ddd]",
                    nav: "bg-[#fcfcfc] text-[#a0a0a0]",
                    navActive: "text-[#595959] border-b-2 border-[#595959]",
                    card: "bg-white",
                    bodyBg: "#f4f4f0"
                },
                cards: {
                    bg: "bg-[#0a0a0c]",
                    header: "bg-[#0a0a0c] text-[#e0e0e0] border-b border-gray-800",
                    nav: "bg-[#111111] text-[#666]",
                    navActive: "text-[#d4a373] border-b-2 border-[#d4a373]",
                    card: "bg-[#1a1a2e]/50 border border-white/5",
                    bodyBg: "#0a0a0c"
                },
                guide: {
                    bg: "bg-[#0f0c29]",
                    header: "bg-[#0f0c29] text-indigo-100 border-b border-indigo-900",
                    nav: "bg-[#1a1b3a] text-indigo-400/50",
                    navActive: "text-indigo-200 border-b-2 border-indigo-200",
                    card: "bg-indigo-900/20 border border-indigo-500/10",
                    bodyBg: "#0f0c29"
                }
            };

            const currentTheme = themes[activeTab];

            // 動態更新 body 背景顏色
            useEffect(() => {
                document.body.style.backgroundColor = currentTheme.bodyBg;
            }, [activeTab]);

            return (
                <div className={`max-w-2xl mx-auto min-h-screen shadow-2xl relative font-sans theme-transition ${currentTheme.bg}`}>
                    
                    {/* Header 主題切換 */}
                    <header className={`p-6 text-center theme-transition relative overflow-hidden ${currentTheme.header}`}>
                        <div className="relative z-10">
                            <h1 className="text-2xl font-medium tracking-[0.3em] mb-1 font-serif">靈感問路站</h1>
                            <p className="text-[10px] opacity-60 tracking-[0.2em] uppercase font-sans">Divination & Guidance</p>
                        </div>
                    </header>

                    {/* Nav 主題切換 */}
                    <nav className={`flex justify-around theme-transition sticky top-0 z-20 shadow-sm ${currentTheme.nav}`}>
                        <button 
                            onClick={() => setActiveTab('blocks')} 
                            className={`flex flex-col items-center p-4 w-1/3 transition-all duration-500 text-xs tracking-widest ${activeTab === 'blocks' ? currentTheme.navActive : 'opacity-60 hover:opacity-100'}`}
                        >
                            <Icons.Moon /><span className="mt-2">擲筊</span>
                        </button>
                        <button 
                            onClick={() => setActiveTab('cards')} 
                            className={`flex flex-col items-center p-4 w-1/3 transition-all duration-500 text-xs tracking-widest ${activeTab === 'cards' ? currentTheme.navActive : 'opacity-60 hover:opacity-100'}`}
                        >
                            <Icons.Cards /><span className="mt-2">三元牌</span>
                        </button>
                        <button 
                            onClick={() => setActiveTab('guide')} 
                            className={`flex flex-col items-center p-4 w-1/3 transition-all duration-500 text-xs tracking-widest ${activeTab === 'guide' ? currentTheme.navActive : 'opacity-60 hover:opacity-100'}`}
                        >
                            <Icons.Compass /><span className="mt-2">指引</span>
                        </button>
                    </nav>

                    {/* Main Content */}
                    <main className="p-4 sm:p-8">
                        <div className={`rounded-xl shadow-lg overflow-hidden theme-transition min-h-[500px] ${currentTheme.card}`}>
                            {activeTab === 'blocks' && <MoonBlocks />}
                            {activeTab === 'cards' && <TriadCards />}
                            {activeTab === 'guide' && <RandomGuide />}
                        </div>
                    </main>

                    <footer className={`text-center p-8 text-xs font-light tracking-widest theme-transition opacity-40 ${activeTab === 'blocks' ? 'text-[#a0a0a0]' : 'text-gray-500'}`}>
                        <p>心誠則靈 · 僅供參考</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>